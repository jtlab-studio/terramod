# Terramod AWS Services Registry
# Phase 1: Core 8 AWS Services

services:
  - aws_vpc:
      domain: networking
      category: core
      required_inputs:
        - cidr_block
      optional_inputs:
        - enable_dns_hostnames
        - enable_dns_support
        - tags
      exports:
        - id
        - cidr_block
      allowed_consumers:
        - aws_subnet
        - aws_security_group
      validation_rules:
        - name: valid_cidr
          message: "VPC CIDR must be valid IPv4 CIDR block"
          severity: error

  - aws_subnet:
      domain: networking
      category: core
      required_inputs:
        - vpc_id
        - cidr_block
        - availability_zone
      optional_inputs:
        - map_public_ip_on_launch
        - tags
      exports:
        - id
        - cidr_block
        - availability_zone
      allowed_consumers:
        - aws_instance
        - aws_lambda_function
      validation_rules:
        - name: subnet_in_vpc
          message: "Subnet CIDR must be within VPC CIDR range"
          severity: error

  - aws_security_group:
      domain: networking
      category: core
      required_inputs:
        - vpc_id
        - name
      optional_inputs:
        - description
        - ingress
        - egress
        - tags
      exports:
        - id
      allowed_consumers:
        - aws_instance
        - aws_lambda_function
      validation_rules:
        - name: no_open_admin_ports
          message: "Admin ports (22, 3389) should not be open to 0.0.0.0/0"
          severity: error
        - name: has_egress
          message: "Security group should have egress rules"
          severity: warning

  - aws_instance:
      domain: compute
      category: core
      required_inputs:
        - ami
        - instance_type
      optional_inputs:
        - subnet_id
        - vpc_security_group_ids
        - key_name
        - user_data
        - iam_instance_profile
        - tags
      exports:
        - id
        - private_ip
        - public_ip
      allowed_consumers: []
      validation_rules:
        - name: requires_subnet
          message: "EC2 instance should be in a subnet"
          severity: error
        - name: requires_security_group
          message: "EC2 instance should have security group"
          severity: warning

  - aws_s3_bucket:
      domain: storage
      category: core
      required_inputs:
        - bucket
      optional_inputs:
        - acl
        - versioning
        - server_side_encryption_configuration
        - tags
      exports:
        - id
        - arn
        - bucket_domain_name
      allowed_consumers: []
      validation_rules:
        - name: encryption_enabled
          message: "S3 bucket should have encryption enabled"
          severity: warning
        - name: versioning_enabled
          message: "S3 bucket should have versioning enabled"
          severity: warning

  - aws_lambda_function:
      domain: serverless
      category: core
      required_inputs:
        - function_name
        - role
        - handler
        - runtime
      optional_inputs:
        - vpc_config
        - environment
        - memory_size
        - timeout
        - tags
      exports:
        - arn
        - invoke_arn
        - function_name
      allowed_consumers: []
      validation_rules:
        - name: requires_iam_role
          message: "Lambda function must have IAM role"
          severity: error
        - name: vpc_requires_subnet_sg
          message: "Lambda in VPC requires subnet_ids and security_group_ids"
          severity: error
        - name: timeout_limit
          message: "Lambda timeout should be reasonable (< 300s recommended)"
          severity: warning

  - aws_iam_role:
      domain: identity
      category: core
      required_inputs:
        - name
        - assume_role_policy
      optional_inputs:
        - description
        - managed_policy_arns
        - inline_policy
        - tags
      exports:
        - arn
        - name
      allowed_consumers:
        - aws_lambda_function
        - aws_instance
      validation_rules:
        - name: no_wildcard_actions
          message: "IAM role should not have wildcard actions (*:*)"
          severity: error
        - name: no_admin_access
          message: "IAM role should not have AdministratorAccess policy"
          severity: error
        - name: least_privilege
          message: "IAM role should follow least privilege principle"
          severity: warning

  - aws_cloudwatch_log_group:
      domain: observability
      category: core
      required_inputs:
        - name
      optional_inputs:
        - retention_in_days
        - kms_key_id
        - tags
      exports:
        - arn
        - name
      allowed_consumers:
        - aws_lambda_function
      validation_rules:
        - name: retention_set
          message: "CloudWatch log group should have retention period set"
          severity: warning
